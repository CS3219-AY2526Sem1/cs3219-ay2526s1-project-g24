version: "3"

services:
  question_service:
    build:
      context: ./apps/question_service
      dockerfile: dockerfile
    # Run migrations and seed data on startup
    command: >
      sh -c "
        echo 'ðŸ”„ Waiting for database...' &&
        sleep 2 &&
        echo 'ðŸ“¦ Running migrations...' &&
        /app/.venv/bin/alembic upgrade head &&
        echo 'ðŸŒ± Seeding database...' &&
        /app/.venv/bin/python -c 'from seed_db import seed_database; from app.questions.models import Topic; from app.core.database import SessionLocal; db = SessionLocal(); existing = db.query(Topic).count(); db.close(); seed_database() if existing == 0 else print(\"âœ… Database already seeded\")' &&
        echo 'ðŸš€ Starting FastAPI server...' &&
        /app/.venv/bin/fastapi run app/main.py --port 80 --host 0.0.0.0
      "

  user_service:
    build:
      context: .
      dockerfile: ./apps/user_service/Dockerfile
